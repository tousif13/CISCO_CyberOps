# 27.2.15 Lab - Investigating a Malware Exploit

> You have decided to interview for a job in a medium sized company as a Tier 1 cybersecurity analyst. You 
have been asked to demonstrate your ability to pinpoint the details of an attack in which a computer was 
compromised. Your goal is to answer a series of questions using Sguil, Kibana, and Wireshark in Security 
Onion.
You have been given the following details about the event:
• The event happened in January of 2017.
• It was discovered by the Snort NIDS

## Part 1: Use Kibana to Learn About a Malware Exploit

* In Part 1, use Kibana to answer the following questions. To help you get started, you are informed that the attack took place at some time during January 2017. You will need to pinpoint the exact time.

### Step 1: Narrow the timeframe

* Login to Security Onion with the `analyst` username and `cyberops` password.
* Open Kibana (username `analyst` and password `cyberops`) and set an Absolute time range to narrow the focus to log data from January 2017.
* You will see a graph appear with a single entry showing. To view more details, you need to narrow the amount of time that is displayed. Narrow the time range in the Total Log Count Over Time visualization by clicking and dragging to select an area around the graph data point. You may need to repeat this process 
until you see some detail in the graph.

![image](https://github.com/tousif13/CISCO_CyberOps/assets/33444140/5ae7261c-87e2-4876-8b15-4f8e974a5ffc)

### Step 2: Locate the Event in Kibana

* After narrowing the time range in the main Kibana dashboard, go to the `NIDS` Alert Data dashboard by clicking NIDS.
* Zoom in on the event by clicking and dragging in the NIDS – Alerts Over Time visualization further focus in on the event timeframe. Since the event happened over a very short period of time, select just the graph plot line. Zoom in until your display resembles the one below.

![image](https://github.com/tousif13/CISCO_CyberOps/assets/33444140/d62db8ee-44ea-456e-8715-8656a2d98d12)

* Click the first point on the timeline to filter for only that first event.
* Now view details for the events that occurred at that time. Scroll all the way to the bottom of the dashboard until you see the `NIDS Alerts` section of the page. The alerts are arranged by time. Expand the first event in the list by clicking the pointer arrow that is to the left of the timestamp

![image](https://github.com/tousif13/CISCO_CyberOps/assets/33444140/c666e89d-db19-4e60-ab01-7db8768f2965)

* Look at the expanded alert details and answer the following questions:
* What is the time of the first detected NIDS alert in Kibana?

      January 27th 2017 - 22:54:43

* What is the source IP address in the alert?

      172.16.4.193

* What is the destination IP address in the alert?

      194.87.234.129
  
* What is the destination port in the alert? What service is this? 

      80 port HTTP

* What is the classification of the alert? 

      trojan-activity
  
* What is the destination geo country name?

      Russia

* In a web browser on a computer that can connect to the internet, go to the link that is provided in the signature_info field of the alert. This will take you to the Emerging Threats Snort alert rule for the exploit. There are a series of rules shown. This is because signatures can change over time, or new and more 
accurate rules are developed. The newest rule is at the top of the page. Examine details of the rule
* What is an Exploit Kit? (EK) Search on the internet to answer this question.

      exploit kits are malicious tools used by cybercriminals to automatically identify and exploit security vulnerabilities in computer systems. They deliver malware to unsuspecting users by exploiting these vulnerabilities, compromising the targeted systems. Exploit kits can be distributed through malicious websites or email attachments, posing a significant threat to computer security.

> Exploit kits frequently use what is called a drive-by attack to begin the attack campaign. In a drive-by 
attack, a user will visit a website that should be considered safe. However, threat actors find ways to 
compromise legitimate websites by finding vulnerabilities on the webservers that host them. The 
vulnerabilities allow threat actors to insert their own malicious code into the HTML of a webpage. The 
code is frequently inserted into an iFrame. iFrames permit content from different websites to be display ed 
in the same webpage. Threat actors will frequently create an invisible iFrame that connects the browser 
to a malicious website. The HTML from the website that is loaded into the browser often contains a 
JavaScript that will send the browser to yet another malicious website or download malware until the 
computer.

### Step 3: View the Transcript capME!

* Click the `alert _id` value, you can pivot to CapME to inspect the transcript of the event
* In the CapME! window you can see the transcript from the session. It shows the transactions between the source computer, in blue, and the destinations that are accessed by the source. A lot of valuable information, including a link to the pcap file that is related to this alert, is available in the transcript.

![image](https://github.com/tousif13/CISCO_CyberOps/assets/33444140/e30b37df-abde-4e46-8425-e544b473e568)

* Examine the first block of blue text. This is the request from the source to the destination webserver. Note that two URLs are listed in this block. The first is tagged as SRC: REFERER. This is the website that the source computer first accessed. However, the server referred browser the HTTP GET request to the 
SRC:HOST. Something in the HTML sent the source to this site. It looks like this could be a drive-by attack!
* What website did the user intend to connect to?

        www.homeimprovement.com
  
* What URL did the browser refer the user to?

      tyu.benme.com

* What kind of content is requested by the source host from tybenme.com? Why could this be a problem? Look in the DST server block of the transcript too.

      The content is gzip. It could probably be a malware file. As it is compressed, the contents of the file are obfuscated and not visible much as a malware.

* Close the CapME! browser tab.
* From the top of the NIDS Alert Dashboard click the `HTTP` entry located under `Zeek Hunting` heading.
* In the HTTP dashboard, verify that your absolute time range includes `2017-01-27 22:54:30.000 to 2017-01-27 22:56:00.000.`
* Scroll down to the HTTP - Sites section of the dashboard.

  ![image](https://github.com/tousif13/CISCO_CyberOps/assets/33444140/0bf45b30-6b44-4501-be9c-87cf19526fe8)

* What are some of the websites that are listed?

      p27dokhpz2n7nvgr.1jw2lx.top
      www.homeimprovement.com
      tyu.benme.com
      www.google-analytics.com
      api.blockcipher.com
      spotsbill.com
      fpdownload2.macromedia.com
      retrotip.visionurbana.com.ve

* We should know some of these websites from the transcript that we read earlier. Not all of the sites that are shown are part of the exploit campaign. Research the URLs by searching for them on the internet. Do not connect to them. Place the URLs in quotes when you do your searches.
* Which of these sites is likely part of the exploit campaign?

      p27dokhpz2n7nvgr.1jw2lx.top
      homeimprovement.com
      tyu.benme.com
      spotsbill.com
      retrotip.visionurbana.com.ve

* What are the HTTP - MIME Types listed in the Tag Cloud?

       text/plain, text/html, image/jpeg, image/gif, image/png, text/json, application/javascript, application/x-shockwave-flash, application/vnd.ms.-fontobject

## Part 2: Investigate the Exploit with Sguil

### Step 1: Open Sguil and locate the alerts.

* Launch Sguil from the desktop. Login with username analyst and password cyberops. Enable all sensors and click Start.
* Locate the group of alerts from January 27th 2017.

  ![image](https://github.com/tousif13/CISCO_CyberOps/assets/33444140/9475a4a0-4071-436e-8924-30dde9d02608)

* According to Sguil, what are the timestamps for the first and last of the alerts that occurred within about a second of each other?

        22:54:42 to 22:55:28

### Step 2: Investigate the alerts in Sguil

* Click the `Show Packet Data` and `Show Rule` checkboxes to see the packet header field information and the IDS signature rule related to the alert.
*  Select the alert ID 5.2 (Event message `ET CURRENT Evil Redirector Leading to EK Jul 12 2016)`.
* According to the IDS signature rule which malware family triggered this alert? You may need to scroll through the alert signature to find this entry

        Malware_family PseudoDarkLeechk

* Maximize the Sguil window and size the Event Message column so that you can see the text of the entire message. Look at the Event Messages for each of the alert IDs related to this attack

![image](https://github.com/tousif13/CISCO_CyberOps/assets/33444140/568501cb-62f9-4d4c-b0ea-8f2b9cbf4b96)

* According to the Event Messages in Sguil what exploit kit (EK) is involved in this attack?

      RIG exploit kit

* Beyond labelling the attack as trojan activity, what other information is provided regarding the type and name of the malware involved?

![image](https://github.com/tousif13/CISCO_CyberOps/assets/33444140/e0f08756-e2b2-4f35-a7ef-e441baa7d3b7)
